{
  "hash": "48b7ac3271ea3fd1996248a37a121732",
  "result": {
    "engine": "knitr",
    "markdown": "# Tutorial 1: Basic deep neural network\n\n**Aims:** To predict a heart disease using a deep neural network.\n\n**Data:** `heartdisease` data from `MLDataR` package.\n\n**Code description:** This codes demonstrate the use of deep neural network through torch but at the same time, still using `tidymodels` functions for splitting data, preprocessing, and performance metrics.\n\n### **Packages**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(torch)\nlibrary(luz)\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(MLDataR)\n```\n:::\n\n\n### **Data**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheart_df <- \nheartdisease %>% \nmutate(across(c(Sex, RestingECG, Angina), as.factor))\n```\n:::\n\n\n**Explore data.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskimr::skim(heart_df)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |         |\n|:------------------------|:--------|\n|Name                     |heart_df |\n|Number of rows           |918      |\n|Number of columns        |10       |\n|_______________________  |         |\n|Column type frequency:   |         |\n|factor                   |3        |\n|numeric                  |7        |\n|________________________ |         |\n|Group variables          |None     |\n\n\n**Variable type: factor**\n\n|skim_variable | n_missing| complete_rate|ordered | n_unique|top_counts                  |\n|:-------------|---------:|-------------:|:-------|--------:|:---------------------------|\n|Sex           |         0|             1|FALSE   |        2|M: 725, F: 193              |\n|RestingECG    |         0|             1|FALSE   |        3|Nor: 552, LVH: 188, ST: 178 |\n|Angina        |         0|             1|FALSE   |        2|N: 547, Y: 371              |\n\n\n**Variable type: numeric**\n\n|skim_variable    | n_missing| complete_rate|   mean|     sd|   p0|    p25|   p50|   p75|  p100|hist  |\n|:----------------|---------:|-------------:|------:|------:|----:|------:|-----:|-----:|-----:|:-----|\n|Age              |         0|             1|  53.51|   9.43| 28.0|  47.00|  54.0|  60.0|  77.0|▁▅▇▆▁ |\n|RestingBP        |         0|             1| 132.40|  18.51|  0.0| 120.00| 130.0| 140.0| 200.0|▁▁▃▇▁ |\n|Cholesterol      |         0|             1| 198.80| 109.38|  0.0| 173.25| 223.0| 267.0| 603.0|▃▇▇▁▁ |\n|FastingBS        |         0|             1|   0.23|   0.42|  0.0|   0.00|   0.0|   0.0|   1.0|▇▁▁▁▂ |\n|MaxHR            |         0|             1| 136.81|  25.46| 60.0| 120.00| 138.0| 156.0| 202.0|▁▃▇▆▂ |\n|HeartPeakReading |         0|             1|   0.89|   1.07| -2.6|   0.00|   0.6|   1.5|   6.2|▁▇▆▁▁ |\n|HeartDisease     |         0|             1|   0.55|   0.50|  0.0|   0.00|   1.0|   1.0|   1.0|▆▁▁▁▇ |\n\n\n:::\n:::\n\n\n### **Split data**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123) \nsplit_ind <- initial_validation_split(heart_df, strata = \"HeartDisease\") \nheart_train <- training(split_ind) \nheart_val <- validation(split_ind) \nheart_test <- testing(split_ind)\n```\n:::\n\n\n### **Preprocessing**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nheart_rc <- \nrecipe(HeartDisease ~., data = heart_train) %>%\nstep_normalize(all_numeric_predictors()) %>%\nstep_dummy(all_factor_predictors())\n\nheart_train_processed <- heart_rc %>% prep() %>% bake(new_data = NULL)\n\nheart_val_processed <- heart_rc %>% prep() %>% bake(new_data = heart_val)\n\nheart_test_processed <- heart_rc %>% prep() %>% bake(new_data = heart_test)\n```\n:::\n\n\n### Conver to dataloader\n\n**Convert to torch dataset**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_train_torch <- \ntensor_dataset(\n    # Features\n    heart_train_processed %>% \n    select(-HeartDisease) %>% \n    as.matrix() %>% \n    torch_tensor(dtype = torch_float()), \n    # Outcome\n    heart_train_processed$HeartDisease %>% \n    torch_tensor(dtype = torch_float()) %>% \n    torch_unsqueeze(2) \n)\n\ndat_val_torch <- \ntensor_dataset(\n    # Features\n    heart_val_processed %>% \n    select(-HeartDisease) %>% \n    as.matrix() %>% \n    torch_tensor(dtype = torch_float()), \n    # Outcome\n    heart_val_processed$HeartDisease %>% \n    torch_tensor(dtype = torch_float()) %>% \n    torch_unsqueeze(2)\n)\n\ndat_test_torch <- \ntensor_dataset( \n    # Features\n    heart_test_processed %>% \n    select(-HeartDisease) %>% \n    as.matrix() %>% \n    torch_tensor(dtype = torch_float()),\n    # Outcome\n    heart_test_processed$HeartDisease %>% \n    torch_tensor(dtype = torch_float()) %>% \n    torch_unsqueeze(2) \n)\n```\n:::\n\n\n**Dataloader**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_dl <- dataloader(dat_train_torch, batch_size = 10, shuffle = TRUE) \nval_dl <- dataloader(dat_val_torch, batch_size = 10, shuffle = FALSE) \ntest_dl <- dataloader(dat_test_torch, batch_size = 10, shuffle = FALSE)\n```\n:::\n\n\n### Specify the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnet <- nn_module( \n    initialize = function(d_in){ \n        self$net <- nn_sequential(\n            nn_linear(d_in, 32),\n            nn_relu(),\n            nn_dropout(0.5),\n            nn_linear(32, 64),\n            nn_relu(),\n            nn_dropout(0.5),\n            nn_linear(64, 1),\n            nn_sigmoid()\n            )\n        },\n    forward = function(x){\n        self$net(x) \n    } \n)\n```\n:::\n\n\n### Fit the model\n\n**Set parameters**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_in <- length(heart_train_processed) - 1 # no of features minus the outcome\n```\n:::\n\n\n**Fit**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted <- \nnet %>% \nsetup( \n    loss = nn_bce_loss(), \n    optimizer = optim_adam, \n    metrics = list(\n        luz_metric_binary_accuracy(), \n        luz_metric_binary_auroc()) \n) %>% \nset_hparams(d_in = d_in) %>% \nfit( \n    train_dl, \n    epoch = 50, \n    valid_data = val_dl \n)\n```\n:::\n\n\n### Training plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted %>% plot()\n```\n\n::: {.cell-output-display}\n![](tabular_tutorial1_files/figure-pdf/unnamed-chunk-11-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n**Better plot**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist <- get_metrics(fitted)\n\nhist %>% \nggplot(aes(x = epoch, y = value, color = set)) + \ngeom_line(linewidth = 1) + # Draw lines \ngeom_point(size = 1.5) + # Add points for clarity \nfacet_wrap(~ metric, scales = \"free_y\", ncol = 1) + # Stack metrics vertically \ntheme_minimal() + \nlabs( \n    title = \"Training vs Validation Metrics\", \n    y = \"Value\", \n    x = \"Epoch\", \n    color = \"Dataset\" \n)\n```\n\n::: {.cell-output-display}\n![](tabular_tutorial1_files/figure-pdf/unnamed-chunk-12-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n### Re-fit the model\n\n**Fit**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted2 <- \nnet %>% \nsetup( \n    loss = nn_bce_loss(), \n    optimizer = optim_adam, \n    metrics = list( \n        luz_metric_binary_accuracy(),\n        luz_metric_binary_auroc() ) \n) %>% \nset_hparams(d_in = d_in) %>% \nfit( \n    train_dl, \n    epoch = 5, \n    valid_data = val_dl \n)\n```\n:::\n\n\n### Predict testing set\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_pred <- fitted2 %>% predict(test_dl)\n\ndat_pred <- \ny_pred %>% \nas_array() %>% \nas_tibble(.name_repair = \"unique\") %>% \n rename(prob = 1) %>%   \nmutate(\n    pred = factor(ifelse(prob > 0.5, 1, 0)),\n    true = factor(heart_test$HeartDisease)\n    )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNew names:\n* `` -> `...1`\n```\n\n\n:::\n\n```{.r .cell-code}\ndat_pred\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 184 x 3\n    prob pred  true \n   <dbl> <fct> <fct>\n 1 0.334 0     1    \n 2 0.432 0     0    \n 3 0.759 1     1    \n 4 0.623 1     1    \n 5 0.311 0     0    \n 6 0.259 0     0    \n 7 0.307 0     0    \n 8 0.694 1     0    \n 9 0.601 1     0    \n10 0.217 0     0    \n# i 174 more rows\n```\n\n\n:::\n:::\n\n\n### Evaluate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitted %>% evaluate(test_dl) # Less accurate\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nA `luz_module_evaluation`\n-- Results ---------------------------------------------------------------------\nloss: 0.3851\nacc: 0.8152\nauc: 0.8978\n```\n\n\n:::\n:::\n\n\n**Confusion matrix**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_pred %>% \nconf_mat(true, pred) %>% \nautoplot(\"heatmap\")\n```\n\n::: {.cell-output-display}\n![](tabular_tutorial1_files/figure-pdf/unnamed-chunk-16-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n**Accuracy**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_pred %>% \naccuracy(truth = true, estimate = pred)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 3\n  .metric  .estimator .estimate\n  <chr>    <chr>          <dbl>\n1 accuracy binary         0.832\n```\n\n\n:::\n:::\n\n\n**Plot ROC**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_pred %>% \nroc_curve(true, prob, event_level = \"second\") %>% \nautoplot()\n```\n\n::: {.cell-output-display}\n![](tabular_tutorial1_files/figure-pdf/unnamed-chunk-18-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\n# ROC-AUC\ndat_pred %>% \nroc_auc(true, prob, event_level = \"second\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 roc_auc binary         0.893\n```\n\n\n:::\n:::\n",
    "supporting": [
      "tabular_tutorial1_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}